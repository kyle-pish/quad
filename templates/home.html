<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='universal.css') }}">
    <style>
        li {
            border: 1px solid #ccc; /* Outline style */
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            width: 500px; /* Set the width */
            margin: 0 auto; /* Center horizontally */
            box-sizing: border-box; /* Include padding and border in width calculation */
        }
        ul {
            list-style: none; /* Remove bullet points */
            padding: 0;
            margin: 0;
        }
        .date-time {
            color: #666; 
        }
        .post-details {
            margin-bottom: 8px; /* Adjust the value to add spacing between elements */
        }
    </style>
</head>

<body>
    {% include 'header.html' %}
    <main>
        <section id="posts" class="mt-10">
            <div class="container text-center">
                <h2>Posts</h2>
                {% if posts %}
                    <ul>
                        {% for post in posts %}
                            <li>
                                <div class="post-details">
                                    <strong>{{ post['username'] }}</strong>
                                    <small class="date-time">{{ post['timestamp'] }}</small>
                                </div>
                                <p>{{ post['post_content'] }}</p>
                                <button class="like-btn{% if post['liked'] %} liked{% endif %}" type="button" data-post-id="{{ post['id'] }}" aria-pressed="{% if post['liked'] %}true{% else %}false{% endif %}">
                                    <svg class="heart" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                                    </svg>
                                    <span class="like-count" id="like-count-{{ post['id'] }}">{{ post['like_count'] }}</span>
                                </button>
                                <button class="comment-btn icon-only" type="button" data-post-id="{{ post['id'] }}" aria-label="Open comments">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 15a2 2 0 0 1-2 2H8l-5 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <span class="comment-count" id="comment-count-{{ post['id'] }}">{{ post.get('comment_count', 0) }}</span>
                                </button>
                            </li>
                            <br><br>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="flex flex-col gap-7 items-center" style="padding-top: 3em;">
                        <img src="/static/imgs/file.svg" width="100" alt="File">
                        <p>No activity from your friends.</p>
                        <a class="cta" href="/search">
                            Add A Friend
                            <svg width="15" height="15" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="enable-background:new 0 0 349.03 349.031" viewBox="0 0 349.03 349.031"><path d="M349.03 141.226v66.579a9.078 9.078 0 0 1-9.079 9.079H216.884v123.067a9.077 9.077 0 0 1-9.079 9.079h-66.579c-5.009 0-9.079-4.061-9.079-9.079V216.884H9.079A9.08 9.08 0 0 1 0 207.805v-66.579a9.079 9.079 0 0 1 9.079-9.079h123.068V9.079c0-5.018 4.069-9.079 9.079-9.079h66.579a9.078 9.078 0 0 1 9.079 9.079v123.068h123.067a9.077 9.077 0 0 1 9.079 9.079z"/></svg>
                        </a>
                    </div>
                {% endif %}
            </div>
        </section>
    </main>
    {% include 'footer.html' %}
    {% include 'comments_modal.html' %}
    <script src="{{ url_for('static', filename='comments.js') }}"></script>
    <script>
    document.querySelectorAll('.like-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const postId = btn.getAttribute('data-post-id');
            const liked = btn.classList.contains('liked');
            const action = liked ? 'unlike' : 'like';
            // optimistic UI: toggle immediately for snappy feel
            btn.classList.toggle('liked', action === 'like');
            btn.setAttribute('aria-pressed', action === 'like' ? 'true' : 'false');
            const heart = btn.querySelector('.heart');
            if (heart) {
                heart.classList.add('pop');
                setTimeout(() => heart.classList.remove('pop'), 200);
            }

            fetch('/like_post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `post_id=${postId}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.like_count !== undefined) {
                    // update count
                    document.getElementById('like-count-' + postId).textContent = data.like_count;
                    // ensure final state matches server
                    btn.classList.toggle('liked', data.liked || action === 'like');
                    btn.setAttribute('aria-pressed', btn.classList.contains('liked') ? 'true' : 'false');
                }
            })
            .catch(() => {
                // revert optimistic toggle on error
                btn.classList.toggle('liked', liked);
                btn.setAttribute('aria-pressed', liked ? 'true' : 'false');
            });
        });
    });
    </script>
</body>
</html>
